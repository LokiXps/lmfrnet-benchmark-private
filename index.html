<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#007aff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="robots" content="noindex, nofollow">
    <title>ブラウザで動く LMFRNet ベンチマーク</title>
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="style.css">
    <!-- ONNX Runtime Web (CDN: WASM版) -->
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.wasm.min.js"></script>
    <script defer src="main.js"></script>
</head>

<body>
    <div class="app-container">
        <header class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-lg font-bold text-gray-900">ローカル環境で画像認識精度実験</h1>
                <p class="text-xs text-gray-500">オンデバイス推論 / オフライン対応</p>
            </div>
            <div id="model-status" class="text-xs px-2 py-1 rounded bg-gray-200 text-gray-500 font-bold">未ロード</div>
        </header>

        <!-- モデル選択 -->
        <div class="panel p-4 bg-white">
            <label class="text-xs text-gray-500 block mb-1 font-bold">モデル選択 (自動ロード)</label>
            <select id="model-select"
                class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2.5">
            </select>
        </div>

        <!-- タブ -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('bench')">1. 精度実験 (200枚)</div>
            <div class="tab" onclick="switchTab('dataset')">2. データセット確認</div>
            <div class="tab" onclick="switchTab('custom')">3. カスタム検証</div>
        </div>

        <!-- ベンチマーク -->
        <div id="view-bench">
            <div class="panel">
                <div class="panel-header">
                    <span>実験結果</span>
                    <span class="model-badge model-name-display">Model: ---</span>
                </div>
                <div class="metrics-grid">
                    <div class="metric-box">
                        <div class="metric-val" id="bench-acc">--</div>
                        <div class="metric-label">正解率 (Accuracy)</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-val" id="bench-conf">--</div>
                        <div class="metric-label">平均確信度</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-val" id="bench-time">--ms</div>
                        <div class="metric-label">平均推論時間</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-val" id="bench-prog">0/200</div>
                        <div class="metric-label">完了数</div>
                    </div>
                </div>
                <div class="p-4 border-t border-[var(--border)]">
                    <button class="primary w-full py-3" id="btn-run-bench" onclick="runBenchmark()" disabled>200枚ベンチマーク実行</button>
                    <div id="bench-progress-container" class="progress-container">
                        <div id="bench-progress-bar" class="progress-bar"></div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <span>実験結果(詳細)</span>
                    <span class="text-xs font-normal text-gray-500">画像クリックで拡大</span>
                </div>
                <div class="max-h-[400px] overflow-y-auto bg-white">
                    <table class="log-table">
                        <thead>
                            <tr>
                                <th class="col-res">判定</th>
                                <th class="col-img">画像(正解)</th>
                                <th>正解ラベル vs 予測結果</th>
                                <th class="col-conf">確信度</th>
                            </tr>
                        </thead>
                        <tbody id="bench-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- データセット確認 -->
        <div id="view-dataset" class="hidden">
            <div class="panel">
                <div class="panel-header">
                    <span>Caltech101 テスト用データセット (200枚)</span>
                </div>
                <div class="p-2 bg-gray-50">
                    <p class="text-xs text-gray-500 mb-2 px-1">ベンチマークに使用される全画像リストです。画像をクリックするとパスを確認できます。</p>
                    <div id="dataset-grid" class="dataset-grid">
                        <div class="p-4 text-center text-gray-400 col-span-full">読み込み中...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- カスタム検証 -->
        <div id="view-custom" class="hidden">
            <div class="panel p-4">
                <div class="mb-4">
                    <label class="block text-xs text-gray-500 font-bold mb-2">検証したい画像を追加 (複数選択可)</label>
                    <input type="file" id="custom-files" accept="image/*" multiple
                        class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"
                        onchange="handleCustomFiles(this)">
                </div>

                <div id="custom-staging"
                    class="space-y-2 mb-4 bg-gray-50 rounded-lg border border-dashed border-gray-300 min-h-[100px] flex flex-col justify-center">
                    <p class="text-xs text-gray-400 text-center">ここにプレビューが表示されます</p>
                </div>

                <div class="flex gap-2">
                    <button class="flex-1 bg-white text-gray-600" onclick="clearCustom()">クリア</button>
                    <button class="primary flex-1" id="btn-run-custom" onclick="runCustomBatch()" disabled>検証開始</button>
                </div>
            </div>

            <div class="panel" id="custom-result-panel" style="display:none;">
                <div class="panel-header">
                    <span>検証結果</span>
                    <span class="model-badge model-name-display">Model: ---</span>
                </div>
                <div class="metrics-grid">
                    <div class="metric-box">
                        <div class="metric-val" id="custom-acc">--</div>
                        <div class="metric-label">正解率</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-val" id="custom-count">0</div>
                        <div class="metric-label">枚数</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-val" id="custom-time">--ms</div>
                        <div class="metric-label">平均時間</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-val" id="custom-conf">--</div>
                        <div class="metric-label">平均確信度</div>
                    </div>
                </div>
                <div class="max-h-[400px] overflow-y-auto bg-white">
                    <table class="log-table">
                        <thead>
                            <tr>
                                <th class="col-res">判定</th>
                                <th class="col-img">画像</th>
                                <th>指定ラベル vs 予測</th>
                                <th class="col-conf">確信度</th>
                            </tr>
                        </thead>
                        <tbody id="custom-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="image-modal" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <img id="modal-img" src="">
            <div class="p-2 bg-white text-center">
                <button class="text-sm text-blue-500 font-bold" onclick="closeModal()">閉じる</button>
            </div>
        </div>
    </div>
</body>

</html>
