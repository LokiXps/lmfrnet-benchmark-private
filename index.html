<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#007aff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="manifest" href="manifest.json">
    <meta name="robots" content="noindex, nofollow">
    <title>ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ç”»åƒèªè­˜ç²¾åº¦å®Ÿé¨“</title>
    <script>
        // Register Service Worker for Offline Support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registered:', reg))
                    .catch(err => console.log('SW registration failed:', err));
            });
        }
    </script>
    <script src="./ort.min.js"></script>
    <script src="./tailwind.min.js"></script>
    <style>
        /* ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰è¨­å®š */
        :root {
            --bg: #f5f5f7;
            --surface: #ffffff;
            --surface-highlight: #f0f0f5;
            --border: #d1d1d6;
            --primary: #007aff;
            --success: #34c759;
            --danger: #ff3b30;
            --text-main: #1c1c1e;
            --text-sub: #8e8e93;
            --font-mono: 'SF Mono', 'Menlo', monospace;
        }

        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Hiragino Kaku Gothic ProN", "Segoe UI", Roboto, sans-serif;
            -webkit-font-smoothing: antialiased;
            padding-bottom: 40px;
            font-size: 14px;
        }

        .app-container {
            max-width: 920px;
            margin: 0 auto;
            padding: 16px;
        }

        .panel {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            background: #fafafa;
            font-weight: 700;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-main);
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background: var(--border);
        }

        .metric-box {
            background: var(--surface);
            padding: 12px;
            text-align: center;
        }

        .metric-val {
            font-size: 20px;
            font-weight: 800;
            font-family: var(--font-mono);
            color: var(--primary);
        }

        .metric-label {
            font-size: 11px;
            color: var(--text-sub);
            margin-top: 4px;
            font-weight: 600;
        }

        /* Improved Table */
        .log-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            table-layout: fixed;
        }

        .log-table th {
            text-align: left;
            color: var(--text-sub);
            font-weight: 600;
            padding: 10px;
            border-bottom: 1px solid var(--border);
            background: #f9f9f9;
            font-size: 11px;
        }

        .log-table td {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
            color: var(--text-main);
        }

        .col-img {
            width: 70px;
        }

        .col-res {
            width: 40px;
            text-align: center;
        }

        .col-conf {
            width: 80px;
            text-align: right;
            font-family: var(--font-mono);
            font-size: 11px;
            color: #888;
        }

        .status-icon {
            font-size: 16px;
        }

        .thumb {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 6px;
            background: #eee;
            border: 1px solid #eee;
            cursor: zoom-in;
            transition: transform 0.1s;
        }

        .thumb:active {
            transform: scale(0.95);
        }

        /* Progress Bar */
        .progress-container {
            height: 6px;
            background: #e5e5ea;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 12px;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.2s ease-out;
        }

        /* Controls */
        select,
        input[type="text"] {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 8px;
            border-radius: 8px;
            width: 100%;
            font-size: 14px;
        }

        button {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--primary);
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        button:active {
            transform: scale(0.98);
            background: #f0f0f0;
        }

        button.primary {
            background: var(--primary);
            color: white;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 122, 255, 0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
            filter: grayscale(100%);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            background: #e5e5ea;
            padding: 4px;
            border-radius: 10px;
        }

        .tab {
            flex: 1;
            padding: 8px;
            text-align: center;
            border-radius: 7px;
            color: #666;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .tab.active {
            background: white;
            color: black;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* Dataset Grid */
        .dataset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            padding: 8px;
        }

        .dataset-item {
            position: relative;
            aspect-ratio: 1;
            overflow: hidden;
            border-radius: 6px;
            border: 1px solid #eee;
        }

        .dataset-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .dataset-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.9);
            font-size: 9px;
            padding: 2px 4px;
            text-align: center;
            border-top: 1px solid #eee;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
            overflow: hidden;
        }

        .modal-content img {
            max-width: 100%;
            max-height: 80vh;
            display: block;
        }

        .model-badge {
            font-size: 11px;
            background: #e0f2fe;
            color: #0369a1;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: normal;
            margin-left: 8px;
            font-family: var(--font-mono);
        }
    </style>
</head>

<body>

    <div class="app-container">
        <header class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-lg font-bold text-gray-900">ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ç”»åƒèªè­˜ç²¾åº¦å®Ÿé¨“</h1>
                <p class="text-xs text-gray-500">ã‚ªãƒ³ãƒ‡ãƒã‚¤ã‚¹æ¨è«– / ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ</p>
            </div>
            <div id="model-status" class="text-xs px-2 py-1 rounded bg-gray-200 text-gray-500 font-bold">æœªãƒ­ãƒ¼ãƒ‰</div>
        </header>

        <!-- SETUP VIEW -->
        <div id="view-setup" class="panel p-8 text-center bg-white shadow-lg rounded-xl">
            <div class="mb-6 text-6xl">ğŸ“¥</div>
            <h2 class="text-xl font-bold mb-2">åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h2>
            <p class="text-sm text-gray-600 mb-8 leading-relaxed">
                ã“ã®ã‚¢ãƒ—ãƒªã¯ã‚µãƒ¼ãƒãƒ¼ã¨é€šä¿¡ã›ãšã€<br>
                ã‚ãªãŸã®ç«¯æœ«å†…ï¼ˆã‚ªãƒ³ãƒ‡ãƒã‚¤ã‚¹ï¼‰ã§AIæ¨è«–ã‚’è¡Œã„ã¾ã™ã€‚<br>
                <br>
                æœ€åˆã«ãƒ¢ãƒ‡ãƒ«ã¨ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’<br>
                ç«¯æœ«ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚<br>
                <span class="text-xs text-gray-400">(ç´„100MB / Wi-Fiç’°å¢ƒã‚’æ¨å¥¨)</span>
            </p>

            <button id="btn-download-start" onclick="startSetup()"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-full shadow-lg text-lg w-full max-w-xs transition-transform active:scale-95">
                ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹
            </button>

            <div id="setup-progress" class="hidden mt-8">
                <div class="flex justify-between text-xs text-gray-500 mb-1">
                    <span id="setup-status-text">æº–å‚™ä¸­...</span>
                    <span id="setup-percent">0%</span>
                </div>
                <div class="h-4 bg-gray-100 rounded-full overflow-hidden border border-gray-200">
                    <div id="setup-bar" class="h-full bg-blue-500 w-0 transition-all duration-200"></div>
                </div>
            </div>
        </div>

        <!-- MAIN VIEW (Hidden initially) -->
        <div id="view-main" class="hidden">
            <div class="panel p-4 bg-white">
                <label class="text-xs text-gray-500 block mb-1 font-bold">ãƒ¢ãƒ‡ãƒ«é¸æŠ (ã‚ªãƒ•ãƒ©ã‚¤ãƒ³)</label>
                <select id="model-select"
                    class="w-full bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2.5">
                </select>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('bench')">1. ç²¾åº¦å®Ÿé¨“ (200æš)</div>
                <div class="tab" onclick="switchTab('dataset')">2. ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç¢ºèª</div>
                <div class="tab" onclick="switchTab('custom')">3. ã‚«ã‚¹ã‚¿ãƒ æ¤œè¨¼</div>
            </div>

            <!-- TAB 1: Benchmark -->
            <div id="view-bench">
                <div class="panel">
                    <div class="panel-header">
                        <span>å®Ÿé¨“çµæœ</span>
                        <span class="model-badge model-name-display">Model: ---</span>
                    </div>
                    <div class="metrics-grid">
                        <div class="metric-box">
                            <div class="metric-val" id="bench-acc">--</div>
                            <div class="metric-label">æ­£è§£ç‡ (Accuracy)</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-val" id="bench-conf">--</div>
                            <div class="metric-label">å¹³å‡ç¢ºä¿¡åº¦</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-val" id="bench-time">--ms</div>
                            <div class="metric-label">å¹³å‡æ¨è«–æ™‚é–“</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-val" id="bench-prog">0/200</div>
                            <div class="metric-label">å®Œäº†æ•°</div>
                        </div>
                    </div>
                    <div class="p-4 border-t border-[var(--border)]">
                        <button class="primary w-full py-3" id="btn-run-bench" onclick="runBenchmark()"
                            disabled>200æšãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œ</button>
                        <div id="bench-progress-container" class="progress-container">
                            <div id="bench-progress-bar" class="progress-bar"></div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-header">
                        <span>å®Ÿé¨“çµæœ(è©³ç´°)</span>
                        <span class="text-xs font-normal text-gray-500">ç”»åƒã‚¯ãƒªãƒƒã‚¯ã§æ‹¡å¤§</span>
                    </div>
                    <div class="max-h-[400px] overflow-y-auto bg-white">
                        <table class="log-table">
                            <thead>
                                <tr>
                                    <th class="col-res">åˆ¤å®š</th>
                                    <th class="col-img">ç”»åƒ(æ­£è§£)</th>
                                    <th>æ­£è§£ãƒ©ãƒ™ãƒ« vs äºˆæ¸¬çµæœ</th>
                                    <th class="col-conf">ç¢ºä¿¡åº¦</th>
                                </tr>
                            </thead>
                            <tbody id="bench-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAB 2: Dataset Preview -->
            <div id="view-dataset" class="hidden">
                <div class="panel">
                    <div class="panel-header">
                        <span>Caltech101 ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ (200æš)</span>
                    </div>
                    <div class="p-2 bg-gray-50">
                        <p class="text-xs text-gray-500 mb-2 px-1">ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã«ä½¿ç”¨ã•ã‚Œã‚‹å…¨ç”»åƒãƒªã‚¹ãƒˆã§ã™ã€‚ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãƒ‘ã‚¹ã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>
                        <div id="dataset-grid" class="dataset-grid">
                            <div class="p-4 text-center text-gray-400 col-span-full">èª­ã¿è¾¼ã¿ä¸­...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 3: Custom -->
            <div id="view-custom" class="hidden">
                <div class="panel p-4">
                    <div class="mb-4">
                        <label class="block text-xs text-gray-500 font-bold mb-2">æ¤œè¨¼ã—ãŸã„ç”»åƒã‚’è¿½åŠ  (è¤‡æ•°é¸æŠå¯)</label>
                        <input type="file" id="custom-files" accept="image/*" multiple
                            class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"
                            onchange="handleCustomFiles(this)">
                    </div>

                    <div id="custom-staging"
                        class="space-y-2 mb-4 bg-gray-50 rounded-lg border border-dashed border-gray-300 min-h-[100px] flex flex-col justify-center">
                        <p class="text-xs text-gray-400 text-center">ã“ã“ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
                    </div>

                    <div class="flex gap-2">
                        <button class="flex-1 bg-white text-gray-600" onclick="clearCustom()">ã‚¯ãƒªã‚¢</button>
                        <button class="primary flex-1" id="btn-run-custom" onclick="runCustomBatch()"
                            disabled>æ¤œè¨¼é–‹å§‹</button>
                    </div>
                </div>

                <div class="panel" id="custom-result-panel" style="display:none;">
                    <div class="panel-header">
                        <span>æ¤œè¨¼çµæœ</span>
                        <span class="model-badge model-name-display">Model: ---</span>
                    </div>
                    <div class="metrics-grid">
                        <div class="metric-box">
                            <div class="metric-val" id="custom-acc">--</div>
                            <div class="metric-label">æ­£è§£ç‡</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-val" id="custom-count">0</div>
                            <div class="metric-label">æšæ•°</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-val" id="custom-time">--ms</div>
                            <div class="metric-label">å¹³å‡æ™‚é–“</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-val" id="custom-conf">--</div>
                            <div class="metric-label">å¹³å‡ç¢ºä¿¡åº¦</div>
                        </div>
                    </div>
                    <div class="max-h-[400px] overflow-y-auto bg-white">
                        <table class="log-table">
                            <thead>
                                <tr>
                                    <th class="col-res">åˆ¤å®š</th>
                                    <th class="col-img">ç”»åƒ</th>
                                    <th>æŒ‡å®šãƒ©ãƒ™ãƒ« vs äºˆæ¸¬</th>
                                    <th class="col-conf">ç¢ºä¿¡åº¦</th>
                                </tr>
                            </thead>
                            <tbody id="custom-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="image-modal" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <img id="modal-img" src="">
            <div class="p-2 bg-white text-center">
                <button class="text-sm text-blue-500 font-bold" onclick="closeModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        const MODEL_OPTIONS = [
            { name: "LMFRNet (Default)", path: "./models_caltech101/lmfrnet_hires.onnx" },
            { name: "LMFRNet Hires", path: "./models_caltech101/lmfrnet.onnx" },
            { name: "MobileNetV3 Large", path: "./models_caltech101/mobilenetv3_large.onnx" },
            { name: "ResNet18", path: "./models_caltech101/resnet18.onnx" }
        ];

        let LABELS = [];
        const LABEL_TRANSLATIONS = {
            "Faces": "é¡”", "Faces_easy": "é¡”(Easy)", "Leopards": "ãƒ’ãƒ§ã‚¦", "Motorbikes": "ãƒã‚¤ã‚¯", "accordion": "ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³",
            "airplanes": "é£›è¡Œæ©Ÿ", "anchor": "éŒ¨", "ant": "ã‚¢ãƒª", "barrel": "æ¨½", "bass": "ãƒã‚¹(é­š)", "beaver": "ãƒ“ãƒ¼ãƒãƒ¼",
            "binocular": "åŒçœ¼é¡", "bonsai": "ç›†æ ½", "brain": "è„³", "brontosaurus": "ãƒ–ãƒ­ãƒ³ãƒˆã‚µã‚¦ãƒ«ã‚¹", "buddha": "ä»åƒ",
            "butterfly": "è¶", "camera": "ã‚«ãƒ¡ãƒ©", "cannon": "å¤§ç ²", "car_side": "è»Š(æ¨ª)", "ceiling_fan": "ã‚·ãƒ¼ãƒªãƒ³ã‚°ãƒ•ã‚¡ãƒ³",
            "cellphone": "æºå¸¯é›»è©±", "chair": "æ¤…å­", "chandelier": "ã‚·ãƒ£ãƒ³ãƒ‡ãƒªã‚¢", "cougar_body": "ã‚¯ãƒ¼ã‚¬ãƒ¼(ä½“)", "cougar_face": "ã‚¯ãƒ¼ã‚¬ãƒ¼(é¡”)",
            "crab": "ã‚«ãƒ‹", "crayfish": "ã‚¶ãƒªã‚¬ãƒ‹", "crocodile": "ãƒ¯ãƒ‹", "crocodile_head": "ãƒ¯ãƒ‹(é ­)", "cup": "ã‚«ãƒƒãƒ—",
            "dalmatian": "ãƒ€ãƒ«ãƒ¡ã‚·ã‚¢ãƒ³", "dollar_bill": "ãƒ‰ãƒ«æœ­", "dolphin": "ã‚¤ãƒ«ã‚«", "dragonfly": "ãƒˆãƒ³ãƒœ",
            "electric_guitar": "ã‚¨ãƒ¬ã‚­ã‚®ã‚¿ãƒ¼", "elephant": "è±¡", "emu": "ã‚¨ãƒŸãƒ¥ãƒ¼", "euphonium": "ãƒ¦ãƒ¼ãƒ•ã‚©ãƒ‹ã‚¢ãƒ ", "ewer": "æ°´å·®ã—",
            "ferry": "ãƒ•ã‚§ãƒªãƒ¼", "flamingo": "ãƒ•ãƒ©ãƒŸãƒ³ã‚´", "flamingo_head": "ãƒ•ãƒ©ãƒŸãƒ³ã‚´(é ­)", "garfield": "ã‚¬ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰",
            "gerenuk": "ã‚²ãƒ¬ãƒŒã‚¯", "gramophone": "è“„éŸ³æ©Ÿ", "grand_piano": "ã‚°ãƒ©ãƒ³ãƒ‰ãƒ”ã‚¢ãƒ", "hawksbill": "ã‚¿ã‚¤ãƒã‚¤(äº€)",
            "headphone": "ãƒ˜ãƒƒãƒ‰ãƒ•ã‚©ãƒ³", "hedgehog": "ãƒãƒªãƒã‚ºãƒŸ", "helicopter": "ãƒ˜ãƒªã‚³ãƒ—ã‚¿ãƒ¼", "ibis": "ãƒˆã‚­",
            "inline_skate": "ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚±ãƒ¼ãƒˆ", "joshua_tree": "ã‚¸ãƒ§ã‚·ãƒ¥ã‚¢ãƒ„ãƒªãƒ¼", "kangaroo": "ã‚«ãƒ³ã‚¬ãƒ«ãƒ¼",
            "ketch": "ã‚±ãƒƒãƒ(å¸†èˆ¹)", "lamp": "ãƒ©ãƒ³ãƒ—", "laptop": "ãƒãƒ¼ãƒˆPC", "llama": "ãƒ©ãƒ", "lobster": "ãƒ­ãƒ–ã‚¹ã‚¿ãƒ¼",
            "lotus": "è“®", "mandolin": "ãƒãƒ³ãƒ‰ãƒªãƒ³", "mayfly": "ã‚«ã‚²ãƒ­ã‚¦", "menorah": "ãƒ¡ãƒãƒ©ãƒ¼", "metronome": "ãƒ¡ãƒˆãƒ­ãƒãƒ¼ãƒ ",
            "minaret": "ãƒŸãƒŠãƒ¬ãƒƒãƒˆ", "nautilus": "ã‚ªã‚¦ãƒ ã‚¬ã‚¤", "octopus": "ã‚¿ã‚³", "okapi": "ã‚ªã‚«ãƒ”", "pagoda": "å¡”",
            "panda": "ãƒ‘ãƒ³ãƒ€", "pigeon": "é³©", "pizza": "ãƒ”ã‚¶", "platypus": "ã‚«ãƒ¢ãƒãƒã‚·", "pyramid": "ãƒ”ãƒ©ãƒŸãƒƒãƒ‰",
            "revolver": "ãƒªãƒœãƒ«ãƒãƒ¼", "rhino": "ã‚µã‚¤", "rooster": "é›„é¶", "saxophone": "ã‚µãƒƒã‚¯ã‚¹", "schooner": "ã‚¹ã‚¯ãƒ¼ãƒŠãƒ¼(èˆ¹)",
            "scissors": "ãƒã‚µãƒŸ", "scorpion": "ã‚µã‚½ãƒª", "sea_horse": "ã‚¿ãƒ„ãƒã‚ªãƒˆã‚·ã‚´", "snoopy": "ã‚¹ãƒŒãƒ¼ãƒ”ãƒ¼",
            "soccer_ball": "ã‚µãƒƒã‚«ãƒ¼ãƒœãƒ¼ãƒ«", "stapler": "ãƒ›ãƒƒãƒã‚­ã‚¹", "starfish": "ãƒ’ãƒˆãƒ‡", "stegosaurus": "ã‚¹ãƒ†ã‚´ã‚µã‚¦ãƒ«ã‚¹",
            "stop_sign": "ä¸€æ™‚åœæ­¢æ¨™è­˜", "strawberry": "ã‚¤ãƒã‚´", "sunflower": "ãƒ’ãƒãƒ¯ãƒª", "tick": "ãƒ€ãƒ‹", "trilobite": "ä¸‰è‘‰è™«",
            "umbrella": "å‚˜", "watch": "è…•æ™‚è¨ˆ", "water_lilly": "ã‚¹ã‚¤ãƒ¬ãƒ³", "wheelchair": "è»Šæ¤…å­", "wild_cat": "ãƒ¤ãƒãƒã‚³",
            "windsor_chair": "ã‚¦ã‚£ãƒ³ã‚¶ãƒ¼ãƒã‚§ã‚¢", "wrench": "ãƒ¬ãƒ³ãƒ", "yin_yang": "é™°é™½"
        };

        let BENCHMARK_DATA = [];
        let customImages = [];
        let session = null;
        let currentModelName = "";
        let isRunning = false;


        const statusEl = document.getElementById('model-status');
        const modelSelect = document.getElementById('model-select');
        const benchTableBody = document.getElementById('bench-table-body');
        const benchAccEl = document.getElementById('bench-acc');
        const benchTimeEl = document.getElementById('bench-time');
        const benchConfEl = document.getElementById('bench-conf');
        const benchProgEl = document.getElementById('bench-prog');
        const benchProgressBar = document.getElementById('bench-progress-bar');
        const benchProgressContainer = document.getElementById('bench-progress-container');
        const datasetGrid = document.getElementById('dataset-grid');
        const btnRunBench = document.getElementById('btn-run-bench');
        const btnRunCustom = document.getElementById('btn-run-custom');
        const customResultPanel = document.getElementById('custom-result-panel');
        const modelNameDisplays = document.querySelectorAll('.model-name-display');

        // Global Error Handler for Mobile Debugging
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            alert('Error: ' + msg + '\nURL: ' + url + '\nLine: ' + lineNo);
            return false;
        };

        // Setup Flow
        async function startSetup() {
            const btn = document.getElementById('btn-download-start');
            const progressDiv = document.getElementById('setup-progress');
            const statusBar = document.getElementById('setup-bar');
            const statusText = document.getElementById('setup-percent');
            const statusLabel = document.getElementById('setup-status-text');

            if (!confirm("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ\n(ç´„100MB)")) return;

            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            progressDiv.classList.remove('hidden');

            const CACHE_NAME = 'lmfrnet-benchmark-v2';

            try {
                // Assets List
                let assets = [
                    './index.html',
                    './manifest.json',
                    './labels.json',
                    './samples.json',
                    './models_caltech101/lmfrnet.onnx',
                    './models_caltech101/lmfrnet_hires.onnx',
                    './models_caltech101/mobilenetv3_large.onnx',
                    './models_caltech101/resnet18.onnx',
                    './ort.min.js',
                    './ort-wasm.wasm',
                    './ort-wasm-simd.wasm',
                    './tailwind.min.js'
                ];

                statusLabel.textContent = "ãƒªã‚¹ãƒˆå–å¾—ä¸­...";
                const samplesRes = await fetch('samples.json');
                const samples = await samplesRes.json();
                samples.forEach(s => assets.push(`./samples/${s.filename}`));

                const total = assets.length;
                let count = 0;

                const cache = await caches.open(CACHE_NAME);

                for (const url of assets) {
                    try {
                        const fileName = url.split('/').pop();
                        statusLabel.textContent = `ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­: ${fileName}`;

                        // Add timestamp to bypass Service Worker cache completely
                        const fetchUrl = `${url}?t=${Date.now()}`;
                        const res = await fetch(fetchUrl, { mode: 'cors', cache: 'no-store' });

                        if (!res.ok) {
                            throw new Error(`Status ${res.status}`);
                        }

                        // Verify content type to prevent caching 404 HTML pages as code
                        const contentType = res.headers.get('content-type');
                        if (contentType && contentType.includes('text/html')) {
                            // Allow HTML files explicitly
                            if (!url.includes('.html')) {
                                throw new Error(`Invalid content type: ${contentType} (Expected binary/json)`);
                            }
                        }

                        // Clone response for cache
                        const responseToCache = res.clone();

                        // Store in cache using the CLEAN url (without query params)
                        await cache.put(url, responseToCache);

                    } catch (e) {
                        console.error('Download failed:', url, e);
                        statusLabel.textContent = "ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ";
                        alert(`ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ${url}\n${e.message}\n\nã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
                        throw e;
                    }

                    count++;
                    const percent = Math.floor((count / total) * 100);
                    statusBar.style.width = `${percent}%`;
                    statusText.textContent = `${percent}%`;
                }

                localStorage.setItem('setup_complete', 'true');

                statusLabel.textContent = "å®Œäº†ï¼";
                statusBar.classList.remove('bg-blue-500');
                statusBar.classList.add('bg-green-500');

                setTimeout(() => {
                    alert("ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼\nã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§æ¨è«–å¯èƒ½ã§ã™ã€‚");
                    location.reload();
                }, 500);

            } catch (e) {
                alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // Init
        window.addEventListener('load', async () => {
            try {
                // Check if setup is done
                if (localStorage.getItem('setup_complete')) {
                    document.getElementById('view-setup').classList.add('hidden');
                    document.getElementById('view-main').classList.remove('hidden');

                    // Manual WASM Loading to bypass internal fetch issues
                    try {
                        statusEl.textContent = "WASMãƒ­ãƒ¼ãƒ‰ä¸­...";
                        const wasmResponse = await fetch('./ort-wasm.wasm');
                        if (!wasmResponse.ok) throw new Error("WASM file not found in cache");
                        const wasmBuffer = await wasmResponse.arrayBuffer();

                        // Verify size (approx 9MB)
                        if (wasmBuffer.byteLength < 1000000) {
                            throw new Error(`Invalid WASM size: ${wasmBuffer.byteLength}`);
                        }

                        ort.env.wasm.wasmBinary = wasmBuffer;
                        ort.env.wasm.numThreads = 1;
                        ort.env.wasm.simd = false;
                        ort.env.wasm.proxy = false;

                        console.log("WASM loaded manually via ArrayBuffer");

                    } catch (e) {
                        console.error("WASM Load Error:", e);
                        alert("WASMãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nå†ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚\n" + e.message);
                        localStorage.removeItem('setup_complete');
                        location.reload();
                        return;
                    }

                    initModelSelect();
                    await loadLabels();
                    await loadSamples();
                    renderDatasetGrid();
                    await loadModel(MODEL_OPTIONS[0].path);
                } else {
                    // Show Setup View (Default)
                }
            } catch (e) {
                alert("Init Error: " + e.message);
            }
        });

        function initModelSelect() {
            modelSelect.innerHTML = '';
            MODEL_OPTIONS.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.path;
                option.textContent = opt.name;
                modelSelect.appendChild(option);
            });
            modelSelect.value = MODEL_OPTIONS[0].path;
            modelSelect.addEventListener('change', (e) => {
                loadModel(e.target.value);
            });
        }

        async function loadLabels() {
            try {
                const res = await fetch('labels.json');
                LABELS = await res.json();
            } catch (e) {
                console.error("Failed to load labels.json", e);
            }
        }

        async function loadSamples() {
            try {
                const res = await fetch('samples.json');
                BENCHMARK_DATA = await res.json();
            } catch (e) {
                console.error("Failed to load samples.json", e);
            }
        }

        async function loadModel(path) {
            const name = path.split('/').pop().replace('.onnx', '');
            currentModelName = name;
            updateModelNameDisplay(name);

            statusEl.textContent = "ãƒ­ãƒ¼ãƒ‰ä¸­...";
            statusEl.className = "text-xs px-2 py-1 rounded bg-yellow-200 text-yellow-800 font-bold";
            enableRunButtons(false);

            try {
                // Remove cache busting for PWA to work offline
                const loadPath = path;

                // Low memory options for mobile
                const options = {
                    executionProviders: ['wasm'],
                    enableCpuMemArena: false,
                    enableMemPattern: false,
                    executionMode: 'sequential'
                };

                session = await ort.InferenceSession.create(loadPath, options);
                statusEl.textContent = "æº–å‚™å®Œäº†";
                statusEl.className = "text-xs px-2 py-1 rounded bg-green-200 text-green-800 font-bold";
                enableRunButtons(true);
            } catch (e) {
                console.error("Main thread load failed:", e);
                statusEl.textContent = "ã‚¨ãƒ©ãƒ¼";
                statusEl.className = "text-xs px-2 py-1 rounded bg-red-200 text-red-800 font-bold";
                alert("ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
            }
        }

        function updateModelNameDisplay(name) {
            modelNameDisplays.forEach(el => el.textContent = `Model: ${name}`);
        }

        function enableRunButtons(enabled) {
            btnRunBench.disabled = !enabled;
            btnRunCustom.disabled = !enabled || customImages.length === 0;
        }

        async function runInference(blob) {
            const pixelData = await loadAndCenterCrop(blob, 224);

            if (!session) {
                throw new Error("Model session not loaded");
            }

            const { probs, inferenceTime } = await runInferenceMainThread(pixelData);
            return { probs, time: inferenceTime };
        }

        async function loadAndCenterCrop(blob, target) {
            const url = URL.createObjectURL(blob);
            try {
                const img = await new Promise((resolve, reject) => {
                    const image = new Image();
                    image.crossOrigin = "anonymous";
                    image.onload = () => resolve(image);
                    image.onerror = reject;
                    image.src = url;
                });

                const canvas = document.createElement('canvas');
                canvas.width = target;
                canvas.height = target;
                const ctx = canvas.getContext('2d');

                // High quality resize settings
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';

                // Python: transforms.Resize(256) -> transforms.CenterCrop(224)
                // JS: Resize short edge to 256, then center crop 224
                const resizeShortEdge = 256;
                const scale = Math.max(resizeShortEdge / img.width, resizeShortEdge / img.height);
                const scaledWidth = img.width * scale;
                const scaledHeight = img.height * scale;

                // Center crop calculation
                const dx = (target - scaledWidth) / 2;
                const dy = (target - scaledHeight) / 2;

                ctx.drawImage(img, dx, dy, scaledWidth, scaledHeight);
                return ctx.getImageData(0, 0, target, target).data;
            } finally {
                URL.revokeObjectURL(url);
            }
        }

        async function runInferenceMainThread(pixelData) {
            const size = 224;
            const float32Data = new Float32Array(3 * size * size);

            // Normalize (Mean=[0.485, 0.456, 0.406], Std=[0.229, 0.224, 0.225])
            for (let i = 0; i < size * size; i++) {
                const r = pixelData[i * 4] / 255.0;
                const g = pixelData[i * 4 + 1] / 255.0;
                const b = pixelData[i * 4 + 2] / 255.0;

                float32Data[i] = (r - 0.485) / 0.229;
                float32Data[size * size + i] = (g - 0.456) / 0.224;
                float32Data[2 * size * size + i] = (b - 0.406) / 0.225;
            }

            const tensor = new ort.Tensor('float32', float32Data, [1, 3, size, size]);
            const feeds = { [session.inputNames[0]]: tensor };

            const start = performance.now();
            const results = await session.run(feeds);
            const end = performance.now();

            const output = results[session.outputNames[0]].data;

            return {
                probs: softmax(Array.from(output)),
                inferenceTime: end - start
            };
        }

        function softmax(arr) {
            const max = Math.max(...arr);
            const exps = arr.map(x => Math.exp(x - max));
            const sum = exps.reduce((a, b) => a + b, 0);
            return exps.map(x => x / sum);
        }

        async function runBenchmark() {
            if (isRunning) return;
            if (!session || BENCHMARK_DATA.length === 0) {
                alert("ãƒ¢ãƒ‡ãƒ«ã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ãŒæº–å‚™ã§ãã¦ã„ã¾ã›ã‚“ã€‚");
                return;
            }
            isRunning = true;
            enableRunButtons(false);

            benchTableBody.innerHTML = '';
            benchAccEl.textContent = '--';
            benchTimeEl.textContent = '--';
            benchConfEl.textContent = '--';
            benchProgEl.textContent = '0/200';
            benchProgressBar.style.width = '0%';
            benchProgressContainer.style.display = 'block';

            let correct = 0;
            let totalTime = 0;
            let totalConf = 0;

            for (let i = 0; i < BENCHMARK_DATA.length; i++) {
                const item = BENCHMARK_DATA[i];
                const imgPath = `./samples/${item.filename}`;

                try {
                    const resp = await fetch(imgPath);
                    const blob = await resp.blob();

                    const { probs, time } = await runInference(blob);

                    const predIndex = probs.indexOf(Math.max(...probs));
                    const confidence = probs[predIndex];
                    const isCorrect = predIndex === item.label;

                    if (isCorrect) correct++;
                    totalTime += time;
                    totalConf += confidence;

                    const row = document.createElement('tr');
                    row.className = isCorrect ? 'bg-green-50' : 'bg-red-50';
                    row.innerHTML = `
                        <td class="col-res text-center">${isCorrect ? 'âœ…' : 'âŒ'}</td>
                        <td class="col-img">
                            <div class="flex items-center gap-2">
                                <img src="${imgPath}" class="w-10 h-10 object-cover rounded border cursor-pointer" onclick="openModal('${imgPath}')">
                                <span class="text-xs text-gray-500">${getLabelName(item.label)}</span>
                            </div>
                        </td>
                        <td class="text-xs">
                            <div>æ­£è§£: ${getLabelName(item.label)}</div>
                            <div class="${isCorrect ? 'text-green-700' : 'text-red-700'} font-bold">äºˆæ¸¬: ${getLabelName(predIndex)}</div>
                        </td>
                        <td class="col-conf text-right font-mono text-xs">
                            ${(confidence * 100).toFixed(1)}%
                        </td>
                    `;
                    benchTableBody.prepend(row);

                    const currentCount = i + 1;
                    benchAccEl.textContent = `${((correct / currentCount) * 100).toFixed(1)}%`;
                    benchTimeEl.innerHTML = `${(totalTime / currentCount).toFixed(1)}ms <span class="text-sm text-gray-400 font-normal">(${time.toFixed(1)}ms)</span>`;
                    benchConfEl.textContent = `${((totalConf / currentCount) * 100).toFixed(1)}%`;
                    benchProgEl.textContent = `${currentCount}/${BENCHMARK_DATA.length}`;
                    benchProgressBar.style.width = `${(currentCount / BENCHMARK_DATA.length) * 100}%`;

                } catch (e) {
                    console.error(`Error processing ${item.filename}:`, e);
                }

                if (i % 5 === 0) {
                    await new Promise(r => setTimeout(r, 0));
                }
            }

            isRunning = false;
            enableRunButtons(true);
            benchProgressContainer.style.display = 'none';
        }

        function handleCustomFiles(input) {
            customImages.forEach(i => URL.revokeObjectURL(i.url));
            customImages = [];
            const container = document.getElementById('custom-staging');
            container.innerHTML = '';

            Array.from(input.files || []).forEach(file => {
                const url = URL.createObjectURL(file);
                const div = document.createElement('div');
                div.className = "flex gap-2 items-center border-b border-gray-200 py-2";

                const img = document.createElement('img');
                img.src = url;
                img.className = "thumb";
                img.onclick = () => openModal(url);

                const select = document.createElement('select');
                let options = `<option value="-1">æ­£è§£ãƒ©ãƒ™ãƒ«ã‚’é¸æŠ...</option>`;
                LABELS.forEach((_, idx) => options += `<option value="${idx}">[${idx}] ${getLabelName(idx)}</option>`);
                select.innerHTML = options;
                select.onchange = (e) => {
                    const t = customImages.find(item => item.url === url);
                    if (t) t.labelIndex = parseInt(e.target.value, 10);
                };

                div.appendChild(img);
                div.appendChild(select);
                container.appendChild(div);
                customImages.push({ file, labelIndex: -1, url });
            });

            document.getElementById('custom-result-panel').style.display = 'none';
            btnRunCustom.disabled = customImages.length === 0 || !session;
        }

        function clearCustom() {
            customImages.forEach(i => URL.revokeObjectURL(i.url));
            customImages = [];
            document.getElementById('custom-staging').innerHTML = '<p class="text-xs text-gray-400 text-center">ã“ã“ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>';
            document.getElementById('custom-result-panel').style.display = 'none';
            btnRunCustom.disabled = true;
        }

        async function runCustomBatch() {
            if (isRunning || customImages.length === 0 || !session) return;

            isRunning = true;
            enableRunButtons(false);
            customResultPanel.style.display = 'block';
            const tbody = document.getElementById('custom-table-body');
            tbody.innerHTML = '';

            let correct = 0;
            let totalTime = 0;
            let totalConf = 0;
            let countWithLabel = 0;

            for (let i = 0; i < customImages.length; i++) {
                const item = customImages[i];
                const { probs, time } = await runInference(item.file);
                const predIndex = probs.indexOf(Math.max(...probs));
                const confidence = probs[predIndex];
                const isCorrect = item.labelIndex !== -1 && predIndex === item.labelIndex;

                totalTime += time;
                totalConf += confidence;
                if (item.labelIndex !== -1) countWithLabel++;
                if (isCorrect) correct++;

                const row = document.createElement('tr');
                row.className = isCorrect ? 'bg-green-50' : (item.labelIndex === -1 ? '' : 'bg-red-50');
                row.innerHTML = `
                    <td class="col-res text-center">${item.labelIndex === -1 ? 'ï¼' : (isCorrect ? 'âœ…' : 'âŒ')}</td>
                    <td class="col-img">
                        <img src="${item.url}" class="thumb" onclick="openModal('${item.url}')">
                    </td>
                    <td class="text-xs">
                        <div>æŒ‡å®š: ${item.labelIndex === -1 ? 'æœªæŒ‡å®š' : getLabelName(item.labelIndex)}</div>
                        <div class="${isCorrect ? 'text-green-700' : 'text-red-700'} font-bold">äºˆæ¸¬: ${getLabelName(predIndex)}</div>
                    </td>
                    <td class="col-conf text-right font-mono text-xs">${(confidence * 100).toFixed(1)}%</td>
                `;
                tbody.appendChild(row);
            }

            const total = customImages.length;
            document.getElementById('custom-count').textContent = `${total}`;
            document.getElementById('custom-time').textContent = `${(totalTime / total).toFixed(0)}ms`;
            document.getElementById('custom-conf').textContent = `${((totalConf / total) * 100).toFixed(1)}%`;
            document.getElementById('custom-acc').textContent = countWithLabel > 0 ? `${((correct / countWithLabel) * 100).toFixed(1)}%` : '--';

            isRunning = false;
            enableRunButtons(true);
        }

        function renderDatasetGrid() {
            datasetGrid.innerHTML = '';
            BENCHMARK_DATA.slice(0, 200).forEach(item => {
                const div = document.createElement('div');
                div.className = "dataset-item";
                div.innerHTML = `
                    <img src="./samples/${item.filename}" loading="lazy">
                    <div class="dataset-label">${getLabelName(item.label)}</div>
                `;
                div.onclick = () => openModal(`./samples/${item.filename}`);
                datasetGrid.appendChild(div);
            });
        }

        function getLabelName(index) {
            const en = LABELS[index];
            if (en) return LABEL_TRANSLATIONS[en] || en;
            return `Unknown (${index})`;
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('[onclick="switchTab(\'' + tabId + '\')"]').forEach(t => t.classList.add('active'));
            document.getElementById('view-bench').classList.add('hidden');
            document.getElementById('view-dataset').classList.add('hidden');
            document.getElementById('view-custom').classList.add('hidden');
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
        }

        function openModal(src) {
            document.getElementById('modal-img').src = src;
            document.getElementById('image-modal').classList.add('active');
        }
        function closeModal() {
            document.getElementById('image-modal').classList.remove('active');
        }
    </script>
</body>

</html>